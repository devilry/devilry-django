{% load i18n %}

<script type="module">

    const toolbarShortcutKeyMapPressed = {
        'ctrl': false,      // CTRL (Windows)
        'Meta': false,      // CMD (macOS)
        'b': false,         // CTRL or CMD + b: bold
        'i': false,         // CTRL or CMD + i: italic
        'k': false,         // CTRL or CMD + k: link
    };

    class DevilryCommentEditor extends HTMLElement {
        constructor () {
            super();
            this.attrRootElementId = this.getAttribute('root-element-id');
            this.attrLabelFor = this.getAttribute('label-for');
            this.attrLabelText = this.getAttribute('label-text');
            this.attrTextareaName = this.getAttribute('textarea-name');
            this.attrTextareaValue = this.getAttribute('textarea-value');
            this.attrHelpText = this.getAttribute('help-text');
            this.attrMarkdownGuideLinkUrl = this.getAttribute('markdown-guide-link-url');
            this.attrMarkdownGuideLinkText = this.getAttribute('markdown-guide-link-text');
        }
        
        get elementId () {
            return `id_${this.attrTextareaName}`;
        }

        connectedCallback () {
            this.renderEditor();
            this.addToolbarOptionEventListeners();
            this.addToolbarKeyboardShortcutEvents();
        }

        /**
         * Renders the HTML for the editor.
         */
        renderEditor () {
            const commentEditor = new DOMParser().parseFromString(`
                <div class="devilry-comment-editor">
                    <div class="devilry-comment-editor-toolbar" aria-hidden="true">
                        <button type="button" id="${this.elementId}_toolbar_option_heading" class="btn btn-default devilry-comment-editor-toolbar__option">
                            <p>Heading</p>
                        </button>
                        <button type="button" id="${this.elementId}_toolbar_option_bold" class="btn btn-default devilry-comment-editor-toolbar__option">
                            <p>Bold</p>
                        </button>
                        <button type="button" id="${this.elementId}_toolbar_option_italic" class="btn btn-default devilry-comment-editor-toolbar__option">
                            <p>Italic</p>
                        </button>
                        <button type="button" id="${this.elementId}_toolbar_option_link" class="btn btn-default devilry-comment-editor-toolbar__option">
                            <p>Link</p>
                        </button>
                    </div>
                    <label for="${this.elementId}" class="screenreader-only">
                        {% translate "Comment" context "devilry comment editor" %}
                    </label>
                    <div class="devilry-comment-editor__textarea">
                        <textarea
                            id="${this.elementId}"
                            cols="40"
                            rows="10"
                            class="devilry-comment-editor-textarea devilrymarkdownwidget form-control"
                            name="${this.attrTextareaName}"
                            aria-describedby="${this.elementId}_help">${this.attrTextareaValue}</textarea>
                        <div class="devilry-comment-editor-textarea--copy"></div>
                    </div>
                    <div class="devilry-comment-editor devilry-comment-editor__example-help">
                        <p id="${this.elementId}_help">
                            ${this.attrHelpText}
                            <a href="${this.attrMarkdownGuideLinkUrl}" target='_blank'>
                                ${this.attrMarkdownGuideLinkText}
                            </a>
                        </p>
                    </div>
                </div>
            `, 'text/html').body.firstChild;
            this.appendChild(commentEditor)
        }

        /**
         * Add event-listeners to toolbar buttons.
         * 
         * Each event-listener ends up calling the `insertAtCursor` with 
         * options according to which toolbar markdown option was pressed.
         */
        addToolbarOptionEventListeners () {
            document.getElementById(`${this.elementId}_toolbar_option_heading`)
                .addEventListener('click', () => {
                    this.toolbarEventActionHeading();
                }, false);
            document.getElementById(`${this.elementId}_toolbar_option_bold`)
                .addEventListener('click', () => {
                    this.toolbarEventActionBold();
                }, false);
            document.getElementById(`${this.elementId}_toolbar_option_italic`)
                .addEventListener('click', () => {
                    this.toolbarEventActionItalic();
                }, false);
            document.getElementById(`${this.elementId}_toolbar_option_link`)
                .addEventListener('click', () => {
                    this.toolbarEventActionLink();
                }, false);
        }

        /**
         * Add keyboard-shortcuts for toolbar actions.
         */
        addToolbarKeyboardShortcutEvents () {
            // Scoped helper function that simply handles prevent default actions for 
            // keyboard-shortcuts, and marks the pressed key as released when the action 
            // is performed.
            function _performToolbarKeyboardShortcutAction (event, actionFunction, key) {
                event.preventDefault();
                event.stopPropagation();
                actionFunction();
                toolbarShortcutKeyMapPressed[key] = false;
            }

            // Add handler for keydown events.
            document.onkeydown = (keyDownEvent) => {
                if (document.activeElement.id === `${this.elementId}`) {
                    toolbarShortcutKeyMapPressed[keyDownEvent.key] = true;
                    if (toolbarShortcutKeyMapPressed['Meta'] || toolbarShortcutKeyMapPressed['ctrl']) {
                        if (toolbarShortcutKeyMapPressed['b']) {
                            _performToolbarKeyboardShortcutAction(
                                keyDownEvent, () => {this.toolbarEventActionBold();}, 'b');
                        } else if (toolbarShortcutKeyMapPressed['i']) {
                            _performToolbarKeyboardShortcutAction(
                                keyDownEvent, () => {this.toolbarEventActionItalic();}, 'i');
                        } else if (toolbarShortcutKeyMapPressed['k']) {
                            _performToolbarKeyboardShortcutAction(
                                keyDownEvent, () => {this.toolbarEventActionLink();}, 'k');
                        }
                    }
                }
            };

            // Add handler for keyup events.
            // All keypress-tracking is set to `false` (not pressed). This ensures that we 
            // don't accidentally use the previous keyboard-shortcut next time a keyboard-shortcut 
            // is used (since it would then be marked as `true` (pressed)).
            document.onkeyup = (keyUpEvent) => {
                if (document.activeElement.id === `${this.elementId}`) {
                    Object.keys(toolbarShortcutKeyMapPressed).forEach(key => {
                        toolbarShortcutKeyMapPressed[key] = false;
                    });
                }
            };
        }

        /**
         * Method for inserting heading markdown-tag at cursor.
         */
        toolbarEventActionHeading () {
            this.insertAtCursor('heading', '\n###', '', 'ADD HEADING HERE');
        }

        /**
         * Method for inserting bold markdown-tag at cursor.
         */
        toolbarEventActionBold () {
            console.log('THIS IS STRANGE');
            this.insertAtCursor('bold', '**', '**', 'ADD BOLD TEXT HERE');
        }

        /**
         * Method for inserting italic markdown-tag at cursor.
         */
        toolbarEventActionItalic () {
            this.insertAtCursor('italic', '*', '*', 'ADD ITALIC TEXT HERE');
        }

        /**
         * Method for inserting link markdown-tag at cursor.
         */
        toolbarEventActionLink () {
            this.insertAtCursor('link', '[', '](url)', 'ADD LINK TEXT HERE');
        }

        /**
         * Inserts markdown-tag at cursor-position.
         * 
         * Inserts markdown-tag at cursor-position, by adding a opening and closing 
         * markdown-tag around the selected text (if any). When the markdown-tag is inserted, 
         * and the value for the text-area is updated, the cursor is placed at the end of the 
         * tagged text (including the closing markdown-tag).
         * 
         * @param {String} type         Type of markdown-tag.
         * @param {String} openingTag   The opening markdown-tag. E.g. for links where the full markdown tag is "[]()", the opening-tag whould be "(".
         * @param {String} closingTag   The closing markdown-tag. E.g. for links where the full markdown tag is "[]()", the closing-tag whould be "]()".
         * @param {String} placeholder  This is the placeholder text inserted between the opening and closing markdown tags if no text is selected.
         */
        insertAtCursor (type, openingTag, closingTag, placeholder) {
            if (type === 'heading') {
                console.log('insert HEADING');
            } else if (type === 'bold') {
                console.log('insert BOLD');
            } else if (type === 'italic') {
                console.log('insert ITALIC');
            } else if (type === 'link') {
                console.log('insert LINK');
            } else {
                throw Error(`Unsupported tag: ${type}`);
            }

            // Get textarea to manipulate
            const textArea = document.getElementById(`${this.elementId}`);

            // Get start and end position of the cursor.
            const cursorStart = textArea.selectionStart;
            const cursorEnd = textArea.selectionEnd;

            // Get text marked in range. This is text, if any, is inserted 
            // between the openingTag and the closingTag.
            let selectedText = textArea.value.substring(cursorStart, cursorEnd);

            // Insert markdown
            if (!selectedText) {
                selectedText = placeholder
            }
            const taggedText = openingTag + selectedText + closingTag
            textArea.value = textArea.value.substring(0, cursorStart) + taggedText + textArea.value.substring(cursorEnd, textArea.value.length)

            // Place focus back to the end of the tagged text.
            textArea.focus()
            textArea.selectionEnd = cursorStart + taggedText.length;
        }
    }

    window.customElements.define('devilry-comment-editor', DevilryCommentEditor);
</script>

<devilry-comment-editor
    root-element-id="id_comment_root"
    label-for="id_{{ widget.name }}"
    label-text="{% translate 'Comment' context 'devilry comment editor' %}"
    textarea-name="{{ widget.name }}"
    textarea-value="{% if widget.value %}{{ widget.value }}{% endif %}"
    help-text="{% blocktranslate trimmed context 'devilry comment editor' %}Write a comment in markdown format. Use <strong>**text here**</strong> for bold and <em>*text here*</em> for italic.{% endblocktranslate %}"
    markdown-guide-link-url="/markdown-help"
    markdown-guide-link-text="{% translate 'Full guide for the markdown we support here' context 'devilry comment editor' %}"
></devilry-comment-editor>
