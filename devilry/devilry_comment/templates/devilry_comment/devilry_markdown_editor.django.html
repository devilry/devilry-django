{% load i18n %}
{% load cradmin_legacy_icon_tags %}

<script type="module">

    const toolbarShortcutKeyMapPressed = {
        'ctrl': false,      // CTRL (Windows)
        'Meta': false,      // CMD (macOS)
        'Enter': false,     // Enter
        'b': false,         // CTRL or CMD + b: bold
        'i': false,         // CTRL or CMD + i: italic
        'k': false,         // CTRL or CMD + k: link
    };
    const TOOLBAR_HEADING = 'heading';
    const TOOLBAR_BOLD = 'bold';
    const TOOLBAR_ITALIC = 'italic';
    const TOOLBAR_LINK = 'link'; 
    const TOOLBAR_CODE_INLINE = 'codeInline';
    const TOOLBAR_CODE_BLOCK = 'codeBlock';
    const TOOLBAR_UNORDERED_LIST = 'unorderedList';
    const TOOLBAR_ORDERED_LIST = 'orderedList';
    const OL_REGEX = '^(\\s*)([0-9]*\\.\\s)';
    const UL_REGEX = '^(\\s*)(\\*\\s)';

    class DevilryCommentEditor extends HTMLElement {
        constructor () {
            super();

            this.attrLabelText = this.getAttribute('labelText');
            this.attrTextareaName = this.getAttribute('name');
            this.attrTextareaValue = this.getAttribute('value');
            this.attrHelpText = this.getAttribute('helpText');
            this.attrMarkdownGuideLinkUrl = this.getAttribute('markdownGuideLinkUrl');
            this.attrMarkdownGuideLinkText = this.getAttribute('markdownGuideLinkText');
            this.attrToolbarConfig = JSON.parse(this.getAttribute('toolbarConfig'));
        }

        get elementId () {
            return `id_${this.attrTextareaName}`;
        }

        connectedCallback () {
            this.renderEditor();
            this.addToolbarOptionEventListeners();
            this.addToolbarKeyboardShortcutEvents();
        }

        /**
         * Renders the HTML for the editor.
         */
        renderEditor () {
            const commentEditor = new DOMParser().parseFromString(`
                <div class="devilry-comment-editor">
                    <div class="devilry-comment-editor-toolbar" aria-hidden="true">
                        <button
                            id="${this.elementId}_toolbar_option_heading"
                            type="button"
                            title="${this.attrToolbarConfig.heading.tooltip}"
                            class="btn btn-default devilry-comment-editor-toolbar__option"
                        >
                            <span class="{% cradmin_icon 'h3' %}"></span>
                        </button>
                        <button
                            id="${this.elementId}_toolbar_option_bold"
                            type="button"
                            title="${this.attrToolbarConfig.bold.tooltip}"
                            class="btn btn-default devilry-comment-editor-toolbar__option"
                        >
                            <span class="{% cradmin_icon 'bold' %}"></span>
                        </button>
                        <button
                            id="${this.elementId}_toolbar_option_italic"
                            type="button"
                            title="${this.attrToolbarConfig.italic.tooltip}"
                            class="btn btn-default devilry-comment-editor-toolbar__option"
                        >
                            <span class="{% cradmin_icon 'italic' %}"></span>
                        </button>
                        <button
                            id="${this.elementId}_toolbar_option_link"
                            type="button"
                            title="${this.attrToolbarConfig.link.tooltip}"
                            class="btn btn-default devilry-comment-editor-toolbar__option"
                        >
                            <span class="{% cradmin_icon 'link' %}"></span>
                        </button>
                        <button
                            id="${this.elementId}_toolbar_option_code_inline"
                            type="button"
                            title="${this.attrToolbarConfig.codeInline.tooltip}"
                            class="btn btn-default devilry-comment-editor-toolbar__option"
                        >
                            <span class="{% cradmin_icon 'codeblock' %}"></span>
                        </button>
                        <button
                            id="${this.elementId}_toolbar_option_code_block"
                            type="button"
                            title="${this.attrToolbarConfig.codeBlock.tooltip}"
                            class="btn btn-default devilry-comment-editor-toolbar__option"
                        >
                            <span class="{% cradmin_icon 'codeblock' %}"></span>
                        </button>
                        <button
                            id="${this.elementId}_toolbar_option_unordered_list"
                            type="button"
                            title="${this.attrToolbarConfig.unorderedList.tooltip}"
                            class="btn btn-default devilry-comment-editor-toolbar__option"
                        >
                            <span class="{% cradmin_icon 'list-ul' %}"></span>
                        </button>
                        <button
                            id="${this.elementId}_toolbar_option_ordered_list"
                            type="button"
                            title="${this.attrToolbarConfig.orderedList.tooltip}"
                            class="btn btn-default devilry-comment-editor-toolbar__option"
                        >
                            <span class="{% cradmin_icon 'list-ol' %}"></span>
                        </button>
                    </div>
                    <label for="${this.elementId}" class="screenreader-only">${this.attrLabelText}</label>
                    <div class="devilry-comment-editor__textarea">
                        <textarea
                            id="${this.elementId}"
                            cols="40"
                            rows="10"
                            class="devilry-comment-editor-textarea devilrymarkdownwidget form-control"
                            name="${this.attrTextareaName}"
                            aria-describedby="${this.elementId}_help">${this.attrTextareaValue}</textarea>
                        <div class="devilry-comment-editor-textarea--copy"></div>
                    </div>
                    <div class="devilry-comment-editor devilry-comment-editor__example-help">
                        <p id="${this.elementId}_help">
                            ${this.attrHelpText}
                            <a href="${this.attrMarkdownGuideLinkUrl}" target='_blank'>
                                ${this.attrMarkdownGuideLinkText}
                            </a>
                        </p>
                    </div>
                </div>
            `, 'text/html').body.firstChild;
            this.appendChild(commentEditor)
        }

        /**
         * Add event-listeners to toolbar buttons.
         * 
         * Each event-listener ends up calling the `insertAtCursor` with 
         * options according to which toolbar markdown option was pressed.
         */
        addToolbarOptionEventListeners () {
            document.getElementById(`${this.elementId}_toolbar_option_heading`)
                .addEventListener('click', () => {
                    this.toolbarEventActionHeading();
                }, false);
            document.getElementById(`${this.elementId}_toolbar_option_bold`)
                .addEventListener('click', () => {
                    this.toolbarEventActionBold();
                }, false);
            document.getElementById(`${this.elementId}_toolbar_option_italic`)
                .addEventListener('click', () => {
                    this.toolbarEventActionItalic();
                }, false);
            document.getElementById(`${this.elementId}_toolbar_option_link`)
                .addEventListener('click', () => {
                    this.toolbarEventActionLink();
                }, false);
            document.getElementById(`${this.elementId}_toolbar_option_code_inline`)
                .addEventListener('click', () => {
                    this.toolbarEventActionCodeInline();
                }, false);
            document.getElementById(`${this.elementId}_toolbar_option_code_block`)
                .addEventListener('click', () => {
                    this.toolbarEventActionCodeBlock();
                }, false);
            document.getElementById(`${this.elementId}_toolbar_option_unordered_list`)
                .addEventListener('click', () => {
                    this.toolbarEventActionUnorderedList();
                }, false);
            document.getElementById(`${this.elementId}_toolbar_option_ordered_list`)
                .addEventListener('click', () => {
                    this.toolbarEventActionOrderedList();
                }, false);
        }

        /**
         * Add keyboard-shortcuts for toolbar actions.
         */
        addToolbarKeyboardShortcutEvents () {
            // Scoped helper function that simply handles prevent default actions for 
            // keyboard-shortcuts, and marks the pressed key as released when the action 
            // is performed.
            function _performToolbarKeyboardShortcutAction (event, actionFunction, key, preventDefault = true) {
                if (preventDefault) {
                    event.preventDefault();
                }
                event.stopPropagation();
                actionFunction();
                toolbarShortcutKeyMapPressed[key] = false;
            }

            // Add handler for keydown events.
            document.onkeydown = (keyDownEvent) => {
                if (document.activeElement.id === `${this.elementId}`) {
                    toolbarShortcutKeyMapPressed[keyDownEvent.key] = true;
                    if (toolbarShortcutKeyMapPressed['Meta'] || toolbarShortcutKeyMapPressed['ctrl']) {
                        if (toolbarShortcutKeyMapPressed['b']) {
                            _performToolbarKeyboardShortcutAction(
                                keyDownEvent, () => {this.toolbarEventActionBold();}, 'b');
                        } else if (toolbarShortcutKeyMapPressed['i']) {
                            _performToolbarKeyboardShortcutAction(
                                keyDownEvent, () => {this.toolbarEventActionItalic();}, 'i');
                        } else if (toolbarShortcutKeyMapPressed['k']) {
                            _performToolbarKeyboardShortcutAction(
                                keyDownEvent, () => {this.toolbarEventActionLink();}, 'k');
                        }
                    } else if (toolbarShortcutKeyMapPressed['Enter']) {
                        _performToolbarKeyboardShortcutAction(
                            keyDownEvent, () => {this.toolbarEventActionOnEnter(keyDownEvent);}, 'Enter', false);
                    }
                }
            };

            // Add handler for keyup events.
            // All keypress-tracking is set to `false` (not pressed). This ensures that we 
            // don't accidentally use the previous keyboard-shortcut next time a keyboard-shortcut 
            // is used (since it would then be marked as `true` (pressed)).
            document.onkeyup = (keyUpEvent) => {
                if (document.activeElement.id === `${this.elementId}`) {
                    Object.keys(toolbarShortcutKeyMapPressed).forEach(key => {
                        toolbarShortcutKeyMapPressed[key] = false;
                    });
                }
            };
        }

        /**
         * Method for inserting heading markdown-tag at cursor.
         */
        toolbarEventActionHeading () {
            this.insertBasicMarkdownAtCursor(TOOLBAR_HEADING, '\n### ', '', this.attrToolbarConfig.heading.placeholderText);
        }

        /**
         * Method for inserting bold markdown-tag at cursor.
         */
        toolbarEventActionBold () {
            this.insertBasicMarkdownAtCursor(TOOLBAR_BOLD, '**', '**', this.attrToolbarConfig.bold.placeholderText);
        }

        /**
         * Method for inserting italic markdown-tag at cursor.
         */
        toolbarEventActionItalic () {
            this.insertBasicMarkdownAtCursor(TOOLBAR_ITALIC, '_', '_', this.attrToolbarConfig.italic.placeholderText);
        }

        /**
         * Method for inserting link markdown-tag at cursor.
         */
        toolbarEventActionLink () {
            this.insertBasicMarkdownAtCursor(TOOLBAR_LINK, '[', '](url)', this.attrToolbarConfig.link.placeholderText);
        }

        /**
         * Method for inserting inline code markdown-tag at cursor.
         */
         toolbarEventActionCodeInline () {
            this.insertBasicMarkdownAtCursor(TOOLBAR_CODE_INLINE, '`', '`', this.attrToolbarConfig.codeInline.placeholderText);
        }

        /**
         * Method for inserting inline code markdown-tag at cursor.
         */
         toolbarEventActionCodeBlock () {
            this.insertBasicMarkdownAtCursor(TOOLBAR_CODE_BLOCK, '```', '\n\n```', this.attrToolbarConfig.codeBlock.placeholderText);
        }

        /**
         * Method for inserting link markdown-tag at cursor.
         */
        toolbarEventActionOnEnter (event) {
            const cursorStartLine = this._getCursorLine();
            if (cursorStartLine.match(UL_REGEX)) {
                this.insertMarkdownListAtCursor(TOOLBAR_UNORDERED_LIST, event);
            } else if (cursorStartLine.match(OL_REGEX)) {
                this.insertMarkdownListAtCursor(TOOLBAR_ORDERED_LIST, event);
            }
        }

        /**
         * Method for inserting link markdown-tag at cursor.
         */
         toolbarEventActionUnorderedList () {
            this.insertMarkdownListAtCursor(TOOLBAR_UNORDERED_LIST);
        }

        /**
         * Method for inserting link markdown-tag at cursor.
         */
         toolbarEventActionOrderedList () {
            this.insertMarkdownListAtCursor(TOOLBAR_ORDERED_LIST);
        }

        /**
         * Inserts markdown-tag at cursor-position.
         * 
         * Inserts markdown-tag at cursor-position, by adding a opening and closing 
         * markdown-tag around the selected text (if any). When the markdown-tag is inserted, 
         * and the value for the text-area is updated, the cursor is placed at the end of the 
         * tagged text (including the closing markdown-tag).
         * 
         * @param {String} type         Type of markdown-tag.
         * @param {String} openingTag   The opening markdown-tag. E.g. for links where the full markdown tag is "[]()", the opening-tag whould be "(".
         * @param {String} closingTag   The closing markdown-tag. E.g. for links where the full markdown tag is "[]()", the closing-tag whould be "]()".
         * @param {String} placeholder  This is the placeholder text inserted between the opening and closing markdown tags if no text is selected.
         */
        insertBasicMarkdownAtCursor (type, openingTag, closingTag, placeholder) {
            if (![TOOLBAR_HEADING, TOOLBAR_BOLD, TOOLBAR_ITALIC, TOOLBAR_LINK, TOOLBAR_CODE_INLINE, TOOLBAR_CODE_BLOCK].includes(type)) {
                throw Error(`Type "${type}" not supported.`);
            }

            // Get textarea to manipulate
            const textArea = document.getElementById(`${this.elementId}`);

            // Get start and end position of the cursor.
            const cursorStart = textArea.selectionStart;
            const cursorEnd = textArea.selectionEnd;

            // Get text marked in range. This is text, if any, is inserted 
            // between the openingTag and the closingTag.
            let selectedText = textArea.value.substring(cursorStart, cursorEnd);

            if (!selectedText) {
                selectedText = placeholder || '';
            }
            const taggedText = openingTag + selectedText + closingTag
            textArea.value = textArea.value.substring(0, cursorStart) + taggedText + textArea.value.substring(cursorEnd, textArea.value.length)

            // Places focus to the marked text as the selected range.
            textArea.focus()
            textArea.selectionStart = cursorStart + openingTag.length;
            textArea.selectionEnd = textArea.selectionStart + selectedText.length;
        }

        /**
         * Lists requires special handling for inserting markdown tags, and does not quite fit 
         * the general solution for simple tags that simply wrap the selected text.
         * 
         * @param {String} type                 Type of markdown-tag.
         * @param {Object} enterKeyPressEvent   Enter key pressed event. Defaults to null. 
         *                                      If this is not null, then keypress is handled 
         *                                      by continuing the list on the current line.
         */
         insertMarkdownListAtCursor (type, enterKeyPressEvent = null) {
            if (![TOOLBAR_UNORDERED_LIST, TOOLBAR_ORDERED_LIST].includes(type)) {
                throw Error(`Type list-type "${type}" not supported.`);
            }

            // Get textarea to manipulate
            const textArea = document.getElementById(`${this.elementId}`);

            // Get start and end position of the cursor.
            const cursorStart = textArea.selectionStart;
            const cursorEnd = textArea.selectionEnd;
            let newSelectionStart = null;
            let newSelectionEnd = null;

            // Get the textarea value as an array split on lines.
            // This array will be updated in-place.
            let textAreaLineArray = textArea.value.split('\n');

            // Get the indexes of which line the start-cursor and the end-cursor is placed.
            const cursorStartIndex = textArea.value.substring(0, cursorStart).split('\n').length - 1;
            const cursorEndIndex = textArea.value.substring(0, cursorEnd).split('\n').length - 1;

            // Get diff between start index and end index.
            const cursorStartEndIndexDiff = cursorEndIndex - cursorStartIndex;

            // New textarea value with list tags inserted
            let newTextAreaValue = '';

            if (enterKeyPressEvent) {
                // Continue list on enter key-press.
                // Handle keypress events such as enter to check if the list should be continued.

                // If multiple lines are selected, continuation of 
                // list is not performed.
                if (cursorStartEndIndexDiff !== 0) {
                    return;
                }
                event.preventDefault();

                // Create insertion value for the new inserted line.
                // This will keep all spaces at the start until the line 
                // tag. If the line-tag is a number, it will be incremented, 
                // and for unordered lists the tag will be kept as is.
                const cursorLine = this._getCursorLine();
                let listTag = '';
                if (type === TOOLBAR_ORDERED_LIST) {
                    const match = cursorLine.match(OL_REGEX);
                    const nextOrderNum = parseInt(match[2]) + 1;
                    listTag = match[1] + nextOrderNum + '. ';
                } else {
                    const match = cursorLine.match(UL_REGEX);
                    listTag = match[1] + match[2];
                }

                textAreaLineArray = [
                    ...textAreaLineArray.slice(0, cursorStartIndex + 1),
                    listTag,
                    ...textAreaLineArray.slice(cursorStartIndex + 1)
                ];

                // Add back newlines removed from split.
                // let newTextAreaValue = '';
                for (let i = 0; i < textAreaLineArray.length; i++) {
                    if (i === 0) {
                        newTextAreaValue += textAreaLineArray[i];
                    } else {
                        newTextAreaValue += `\n${textAreaLineArray[i]}`;
                    }
                }
            } else {
                // Convert marked text to list.
                // Handles the case where a block of text has been selected should be converted to a list.

                let markdownListTag = type === TOOLBAR_UNORDERED_LIST ? '* ' : '1. ';
                let orderedListCounter = 1;
                for (let i = cursorStartIndex; i <= cursorEndIndex; i++) {
                    if (type === TOOLBAR_ORDERED_LIST) {
                        markdownListTag = `${orderedListCounter}. `;
                        orderedListCounter++;
                    }
                    textAreaLineArray[i] = `${markdownListTag}${textAreaLineArray[i]}`;
                }

                // Add newline at the start if the before the startcursor line has content and/or
                // add newline to the end if the line after endcursor has content.
                if (cursorStartIndex > 0 && textAreaLineArray[cursorStartIndex - 1].trim().length > 0) {
                    textAreaLineArray[cursorStartIndex] = `\n${textAreaLineArray[cursorStartIndex]}`;
                }
                if (cursorEndIndex < textAreaLineArray.length - 1 && textAreaLineArray[cursorEndIndex + 1].trim().length > 0) {
                    textAreaLineArray[cursorEndIndex] = `${textAreaLineArray[cursorEndIndex]}\n`;
                }

                // Add back newlines removed from split.
                for (let i = 0; i < textAreaLineArray.length; i++) {
                    if (i === 0) {
                        newTextAreaValue += textAreaLineArray[i];
                    } else {
                        newTextAreaValue += `\n${textAreaLineArray[i]}`;
                    }
                }
                if (cursorStartEndIndexDiff === 0) {
                    newSelectionStart = cursorStart + markdownListTag.length;
                    newSelectionEnd = cursorEnd + markdownListTag.length;
                } else {
                    newSelectionStart = cursorStart + markdownListTag.length;
                    newSelectionEnd = cursorEnd + (cursorStartEndIndexDiff * markdownListTag.length) + markdownListTag.length;
                }
            }
            textArea.focus();
            textArea.value = newTextAreaValue;
            if (newSelectionStart) {
                textArea.selectionStart = newSelectionStart;    
            }
            if (newSelectionEnd) {
                textArea.selectionEnd = newSelectionEnd;
            }
        }

        _getCursorLine () {
            const textArea = document.getElementById(`${this.elementId}`);
            const cursorStart = textArea.selectionStart;
            return textArea.value.substring(0, cursorStart).split('\n').slice(-1)[0];
        }
    }

    window.customElements.define('devilry-comment-editor', DevilryCommentEditor);
</script>

<devilry-comment-editor {{ attributes|safe }}></devilry-comment-editor>
