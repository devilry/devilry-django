{% load i18n %}

<script type="module">

    const toolbarShortcutKeyMapPressed = {
        'ctrl': false,      // CTRL (Windows)
        'Meta': false,      // CMD (macOS)
        'b': false,         // CTRL or CMD + b: bold
        'i': false,         // CTRL or CMD + i: italic
        'k': false,         // CTRL or CMD + k: link
    };

    class DevilryCommentEditor extends HTMLElement {
        constructor () {
            super();
            this.attrLabelText = this.getAttribute('labelText');
            this.attrTextareaName = this.getAttribute('name');
            this.attrTextareaValue = this.getAttribute('value');
            this.attrHelpText = this.getAttribute('helpText');
            this.attrMarkdownGuideLinkUrl = this.getAttribute('markdownGuideLinkUrl');
            this.attrMarkdownGuideLinkText = this.getAttribute('markdownGuideLinkText');
            this.attrToolbarConfig = JSON.parse(this.getAttribute('toolbarConfig'));
        }

        get elementId () {
            return `id_${this.attrTextareaName}`;
        }

        connectedCallback () {
            this.renderEditor();
            this.addToolbarOptionEventListeners();
            this.addToolbarKeyboardShortcutEvents();
        }

        /**
         * Renders the HTML for the editor.
         */
        renderEditor () {
            const commentEditor = new DOMParser().parseFromString(`
                <div class="devilry-comment-editor">
                    <div class="devilry-comment-editor-toolbar" aria-hidden="true">
                        <button
                            id="${this.elementId}_toolbar_option_heading"
                            type="button"
                            title="${this.attrToolbarConfig.heading.tooltip}"
                            class="btn btn-default devilry-comment-editor-toolbar__option"
                        >
                            <p>Heading</p>
                        </button>
                        <button
                            id="${this.elementId}_toolbar_option_bold"
                            type="button"
                            title="${this.attrToolbarConfig.bold.tooltip}"
                            class="btn btn-default devilry-comment-editor-toolbar__option"
                        >
                            <p>Bold</p>
                        </button>
                        <button
                            id="${this.elementId}_toolbar_option_italic"
                            type="button"
                            title="${this.attrToolbarConfig.italic.tooltip}"
                            class="btn btn-default devilry-comment-editor-toolbar__option"
                        >
                            <p>Italic</p>
                        </button>
                        <button
                            id="${this.elementId}_toolbar_option_link"
                            type="button"
                            title="${this.attrToolbarConfig.link.tooltip}"
                            class="btn btn-default devilry-comment-editor-toolbar__option"
                        >
                            <p>Link</p>
                        </button>
                    </div>
                    <label for="${this.elementId}" class="screenreader-only">${this.attrLabelText}</label>
                    <div class="devilry-comment-editor__textarea">
                        <textarea
                            id="${this.elementId}"
                            cols="40"
                            rows="10"
                            class="devilry-comment-editor-textarea devilrymarkdownwidget form-control"
                            name="${this.attrTextareaName}"
                            aria-describedby="${this.elementId}_help">${this.attrTextareaValue}</textarea>
                        <div class="devilry-comment-editor-textarea--copy"></div>
                    </div>
                    <div class="devilry-comment-editor devilry-comment-editor__example-help">
                        <p id="${this.elementId}_help">
                            ${this.attrHelpText}
                            <a href="${this.attrMarkdownGuideLinkUrl}" target='_blank'>
                                ${this.attrMarkdownGuideLinkText}
                            </a>
                        </p>
                    </div>
                </div>
            `, 'text/html').body.firstChild;
            this.appendChild(commentEditor)
        }

        /**
         * Add event-listeners to toolbar buttons.
         * 
         * Each event-listener ends up calling the `insertAtCursor` with 
         * options according to which toolbar markdown option was pressed.
         */
        addToolbarOptionEventListeners () {
            document.getElementById(`${this.elementId}_toolbar_option_heading`)
                .addEventListener('click', () => {
                    this.toolbarEventActionHeading();
                }, false);
            document.getElementById(`${this.elementId}_toolbar_option_bold`)
                .addEventListener('click', () => {
                    this.toolbarEventActionBold();
                }, false);
            document.getElementById(`${this.elementId}_toolbar_option_italic`)
                .addEventListener('click', () => {
                    this.toolbarEventActionItalic();
                }, false);
            document.getElementById(`${this.elementId}_toolbar_option_link`)
                .addEventListener('click', () => {
                    this.toolbarEventActionLink();
                }, false);
        }

        /**
         * Add keyboard-shortcuts for toolbar actions.
         */
        addToolbarKeyboardShortcutEvents () {
            // Scoped helper function that simply handles prevent default actions for 
            // keyboard-shortcuts, and marks the pressed key as released when the action 
            // is performed.
            function _performToolbarKeyboardShortcutAction (event, actionFunction, key) {
                event.preventDefault();
                event.stopPropagation();
                actionFunction();
                toolbarShortcutKeyMapPressed[key] = false;
            }

            // Add handler for keydown events.
            document.onkeydown = (keyDownEvent) => {
                if (document.activeElement.id === `${this.elementId}`) {
                    toolbarShortcutKeyMapPressed[keyDownEvent.key] = true;
                    if (toolbarShortcutKeyMapPressed['Meta'] || toolbarShortcutKeyMapPressed['ctrl']) {
                        if (toolbarShortcutKeyMapPressed['b']) {
                            _performToolbarKeyboardShortcutAction(
                                keyDownEvent, () => {this.toolbarEventActionBold();}, 'b');
                        } else if (toolbarShortcutKeyMapPressed['i']) {
                            _performToolbarKeyboardShortcutAction(
                                keyDownEvent, () => {this.toolbarEventActionItalic();}, 'i');
                        } else if (toolbarShortcutKeyMapPressed['k']) {
                            _performToolbarKeyboardShortcutAction(
                                keyDownEvent, () => {this.toolbarEventActionLink();}, 'k');
                        }
                    }
                }
            };

            // Add handler for keyup events.
            // All keypress-tracking is set to `false` (not pressed). This ensures that we 
            // don't accidentally use the previous keyboard-shortcut next time a keyboard-shortcut 
            // is used (since it would then be marked as `true` (pressed)).
            document.onkeyup = (keyUpEvent) => {
                if (document.activeElement.id === `${this.elementId}`) {
                    Object.keys(toolbarShortcutKeyMapPressed).forEach(key => {
                        toolbarShortcutKeyMapPressed[key] = false;
                    });
                }
            };
        }

        /**
         * Method for inserting heading markdown-tag at cursor.
         */
        toolbarEventActionHeading () {
            this.insertAtCursor('heading', '\n###', '', this.attrToolbarConfig.heading.placeholderText);
        }

        /**
         * Method for inserting bold markdown-tag at cursor.
         */
        toolbarEventActionBold () {
            this.insertAtCursor('bold', '**', '**', this.attrToolbarConfig.bold.placeholderText);
        }

        /**
         * Method for inserting italic markdown-tag at cursor.
         */
        toolbarEventActionItalic () {
            this.insertAtCursor('italic', '*', '*', this.attrToolbarConfig.italic.placeholderText);
        }

        /**
         * Method for inserting link markdown-tag at cursor.
         */
        toolbarEventActionLink () {
            this.insertAtCursor('link', '[', '](url)', this.attrToolbarConfig.link.placeholderText);
        }

        /**
         * Inserts markdown-tag at cursor-position.
         * 
         * Inserts markdown-tag at cursor-position, by adding a opening and closing 
         * markdown-tag around the selected text (if any). When the markdown-tag is inserted, 
         * and the value for the text-area is updated, the cursor is placed at the end of the 
         * tagged text (including the closing markdown-tag).
         * 
         * @param {String} type         Type of markdown-tag.
         * @param {String} openingTag   The opening markdown-tag. E.g. for links where the full markdown tag is "[]()", the opening-tag whould be "(".
         * @param {String} closingTag   The closing markdown-tag. E.g. for links where the full markdown tag is "[]()", the closing-tag whould be "]()".
         * @param {String} placeholder  This is the placeholder text inserted between the opening and closing markdown tags if no text is selected.
         */
        insertAtCursor (type, openingTag, closingTag, placeholder) {
            // Get textarea to manipulate
            const textArea = document.getElementById(`${this.elementId}`);

            // Get start and end position of the cursor.
            const cursorStart = textArea.selectionStart;
            const cursorEnd = textArea.selectionEnd;

            // Get text marked in range. This is text, if any, is inserted 
            // between the openingTag and the closingTag.
            let selectedText = textArea.value.substring(cursorStart, cursorEnd);

            // Insert markdown
            if (!selectedText) {
                selectedText = placeholder
            }
            const taggedText = openingTag + selectedText + closingTag
            textArea.value = textArea.value.substring(0, cursorStart) + taggedText + textArea.value.substring(cursorEnd, textArea.value.length)

            // Place focus back to the end of the tagged text.
            textArea.focus()
            textArea.selectionEnd = cursorStart + taggedText.length;
        }
    }

    window.customElements.define('devilry-comment-editor', DevilryCommentEditor);
</script>

<devilry-comment-editor {{ attributes|safe }}></devilry-comment-editor>
